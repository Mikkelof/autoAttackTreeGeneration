ID,Name,Abstraction,Status,Description,Alternate Terms,Likelihood Of Attack,Typical Severity,Related Attack Patterns,Execution Flow,Prerequisites,Skills Required,Resources Required,Indicators,Consequences,Mitigations,Example Instances,Related Weaknesses,Taxonomy Mappings,Notes
676,NoSQL Injection,Standard,Stable,"An adversary targets software that constructs NoSQL statements based on user input or with parameters vulnerable to operator replacement in order to achieve a variety of technical impacts such as escalating privileges, bypassing authentication, and/or executing code.",,High,High,::NATURE:ChildOf:CAPEC ID:248::,"::STEP:1:PHASE:Explore:DESCRIPTION:[Survey target application] Due to the number of NoSQL databases available and the numerous language/API combinations of each, the adversary must first survey the target application to learn what technologies are being leveraged and how they interact with user-driven data.:TECHNIQUE:Determine the technology stack leveraged by the target application, such as the application server, drivers, frameworks, APIs, and databases being utilized.:TECHNIQUE:Identify areas of the application that interact with user input and may be involved with NoSQL queries.::STEP:2:PHASE:Experiment:DESCRIPTION:[Identify user-controllable input susceptible to injection] After identifying the technology stack being used and where user-driven input is leveraged, determine the user-controllable input susceptible to injection such as authentication or search forms. For each user-controllable input that the adversary suspects is vulnerable to NoSQL injection, attempt to inject characters or keywords that have special meaning in the given NoSQL database or language (e.g., $ne for MongoDB or $exists for PHP/MongoDB), or JavaScript that can be executed within the application. The goal is to create a NoSQL query with an invalid syntax.:TECHNIQUE:Use web browser to inject input through text fields or through HTTP GET parameters.:TECHNIQUE:Use a web application debugging tool such as Tamper Data, TamperIE, WebScarab,etc. to modify HTTP POST parameters, hidden fields, non-freeform fields, etc.:TECHNIQUE:Use network-level packet injection tools such as netcat to inject input:TECHNIQUE:Use modified client (modified by reverse engineering) to inject input.::STEP:3:PHASE:Experiment:DESCRIPTION:[Experiment with NoSQL Injection vulnerabilities] After determining that a given input is vulnerable to NoSQL Injection, hypothesize what the underlying query looks like. Iteratively try to add logic to the query to extract information from the database, modify/delete information in the database, or execute commands on the server.:TECHNIQUE:Use public resources such as OWASP's Testing for NoSQL Injection [REF-668] or Null Sweep's NoSQL Injection Cheatsheet [REF-669] and try different approaches for adding logic to NoSQL queries.:TECHNIQUE:Iteratively add logic to the NoSQL query and use detailed error messages from the server to debug the query.:TECHNIQUE:Attempt an HTTP Parameter Pollution attack to replace language-specific keywords, such as where within PHP [CAPEC-460].::STEP:4:PHASE:Exploit:DESCRIPTION:[Exploit NoSQL Injection vulnerability] After refining and adding various logic to NoSQL queries, craft and execute the underlying NoSQL query that will be used to attack the target system.:TECHNIQUE:Craft and Execute underlying NoSQL query::","::Awareness of the technology stack being leveraged by the target application.::NoSQL queries used by the application to store, retrieve, or modify data.::User-controllable input that is not properly validated by the application as part of NoSQL queries.::Target potentially susceptible to operator replacement attacks.::","::SKILL:For keyword and JavaScript injection attacks, it is fairly simple for someone with basic NoSQL knowledge to perform NoSQL injection, once the target's technology stack has been determined.:LEVEL:Low::SKILL:For operator replacement attacks, the adversary must also have knowledge of HTTP Parameter Pollution attacks and how to conduct them.:LEVEL:Medium::",::None: No specialized resources are required to execute this type of attack.::,"::Too many false or invalid queries to the database, especially those caused by malformed input.::Executed queries or commands that appear to malicious in nature or originating from an untrustworthy source.::",::SCOPE:Integrity:TECHNICAL IMPACT:Modify Data::SCOPE:Confidentiality:TECHNICAL IMPACT:Read Data::SCOPE:Confidentiality:SCOPE:Integrity:SCOPE:Availability:TECHNICAL IMPACT:Execute Unauthorized Commands:NOTE:Run Arbitrary Code::SCOPE:Confidentiality:SCOPE:Access Control:SCOPE:Authorization:TECHNICAL IMPACT:Gain Privileges::,"::Strong input validation - All user-controllable input must be validated and filtered for illegal characters as well as relevant NoSQL and JavaScript content. NoSQL-specific keywords, such as $ne, $eq or $gt for MongoDB, must be filtered in addition to characters such as a single-quote(') or semicolons (;) based on the context in which they appear. Validation should also extend to expected types.::If possible, leverage safe APIs (e.g., PyMongo and Flask-PyMongo for Python and MongoDB) for queries as opposed to building queries from strings.::Ensure the most recent version of a NoSQL database and it's corresponding API are used by the application.::Use of custom error pages - Adversaries can glean information about the nature of queries from descriptive error messages. Input validation must be coupled with customized error pages that inform about an error without disclosing information about the database or application.::Exercise the principle of Least Privilege with regards to application accounts to minimize damage if a NoSQL injection attack is successful.::If using MongoDB, disable server-side JavaScript execution and leverage a sanitization module such as mongo-sanitize.::If using PHP with MongoDB, ensure all special query operators (starting with $) use single quotes to prevent operator replacement attacks.::Additional mitigations will depend on the NoSQL database, API, and programming language leveraged by the application.::","::The following examples primarily cite MongoDB, PHP, and NodeJS attacks due to their prominence and popularity. However, please note that these attacks are not exclusive to this NoSQL instance, programming language, or runtime framework. Within NodeJS, Login Bypass attacks are possible via MongoDB if user-input is not properly validated and sanitized [REF-670]. //NodeJS with Express.jsdb.collection('users').find({user: req.query.user,password: req.query.password}); The above code works fine if the user were to submit a query like the following: https://example.org/login?user=patrick&password=1234 But an adversary could submit a malicious query such as the below, which would be interpreted by the code as follows: https://example.org/login?user=patrick&password[$ne]= //NodeJS with Express.jsdb.collection('users').find({user: bob,password: {&ne: }}); This will result in a Login Bypass attack, as the query will succeed for all values where Bob's password is not an empty string.::MongoDB instances are also vulnerable to JavaScript Injection Attacks when user input is not properly validated and sanitized. //PHP with MongoDBdb.collection.find({$where: function() {return (this.username == $username) } } ); If the user properly specifies a username, then this code will execute as intended. However, an adversary can inject JavaScript into the $username variable to achieve a NoSQL Injection attack as follows: //PHP with MongoDBdb.collection.find({$where: function() {return (this.username == 'foo'; sleep(5000) ) } } ); This will result in the server sleeping for 5 seconds if the attack was successful. An adversary could supply a larger value to deny service to the application.::If leveraging PHP with MongoDB, operator replacement attacks are possible if special query operators are not properly addressed. The below example from OWASP's Test for NoSQL Injection displays a simple case of how this could occur.[REF-668] db.myCollection.find({$where: function() {return obj.credits - obj.debits < 0; } } ); Even though the above query does not depend on any user input, it is vulnerable to a NoSQL injection attack via operator replacement on the $where keyword. In this case, the adversary could exploit MongoDB in the following manner: $where: function() { //arbitrary JavaScript here }::",::943::1286::,,,
